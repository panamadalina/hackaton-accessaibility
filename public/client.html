<!DOCTYPE html>
<html lang="en">

<head>
  <title>Microsoft Demo</title>
  <meta charset="utf-8" />
</head>

<body>



  <div id="speechToText">

    <button id="scenarioStartButton">recognizeOnceAsync()</button>
    <button id="scenarioStopButton" disabled="">STOP recognizeOnceAsync()</button>
  </div>

  <div id="textToSpeech" style="display:block">
    <h1 style="font-weight:500;">Microsoft Cognitive Services Speech </h1>
    
    <p>Input Text (max 255 char)</p>
    <textarea id="phraseDiv" style="display: inline-block;width:500px;height:50px"  maxlength="255"
    >BunÄƒ tuturor!</textarea>
    <!-- <div>
      <button id="clientAudioAzure" onclick="getSpeechFromAzure()">Get directly from Azure</button>
    </div> -->

    <div>
      <p>Stream audio from server</p>
      <button  onclick="getSpeechfromServer()">Get from server</button>
      <audio autoplay id="loadingAudioStream"  controls="controls" style=" display: none; visibility: hidden"></audio>
      <audio autoplay id="serverAudioStream"  controls="controls" style=" display: none; visibility: hidden"></audio>
    </div>
  </div>

  <!-- Speech SDK reference sdk. -->
  <script
    src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js">
    </script>

  <!-- Speech SDK USAGE -->
  <script>
    // status fields and start button in UI
    var phraseDiv;

    // subscription key and region for speech services.
    var resourceKey = '7288c10f030b4911a55596df1c605599';
    var resourceRegion = "eastus";
    var authorizationToken;
    var SpeechSDK;
    var synthesizer;

    var phrase = "all good men must come to the aid"
    var queryString = null;

    var audioType = "audio/mpeg";
    var serverSrc = "/text-to-speech";


    function DisplayError(error) {
      window.alert(JSON.stringify(error));
    }


  // Text to speech conversion from server API
  function getSpeechfromServer() {
    getSpeechFromAzure("Got it! Loading...",()=>
    {
      //getSpeechFromServer();
      phrase=document.getElementById('phraseDiv').value.trim(); //Text de tradus!
      var serverSrc = `/text-to-speech`
      
      var serverAudioStreamControl = document.getElementById('serverAudioStream');
      const streamQueryString = `phrase=${phrase}`;
      serverAudioStreamControl.src = `${serverSrc}?${streamQueryString}`;
      console.log(serverAudioStreamControl.src)
      serverAudioStreamControl.type = "audio/mpeg";
      serverAudioStreamControl.disabled = true;
      document.getElementById('serverAudioStream').style.display = 'block';
      document.getElementById('serverAudioStream').style.visibility = 'hidden';
    });
    
}
////////////////
    
    // Loading sound voice from Azure Cognitive Services
    function getSpeechFromAzure(phraseOrWord,callback) {

      phrase=phraseOrWord //|| document.getElementById('phraseDiv').value.trim(); //Text de tradus!
      // authorization for Speech service
      var speechConfig = SpeechSDK.SpeechConfig.fromSubscription(resourceKey, resourceRegion);

      // new Speech object
      synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig);

      synthesizer.speakTextAsync(
        phrase,
        function (result) {

          // Success function

          // display status
          if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {

            // load client-side audio control from Azure response
            audioElement = document.getElementById("loadingAudioStream");
            const blob = new Blob([result.audioData], { type: "audio/mpeg" });
            const url = window.URL.createObjectURL(blob);
            const sleep = ms => new Promise(r => setTimeout(r, ms));
            sleep(1000).then(()=>{
              callback();
            });

          } else if (result.reason === SpeechSDK.ResultReason.Canceled) {
            // display Error
            throw (result.errorDetails);
          }

          // clean up
          synthesizer.close();
          synthesizer = undefined;
        },
        function (err) {

          // Error function
          throw (err);
          audioElement = document.getElementById("audioControl");
          audioElement.disabled = true;

          // clean up
          synthesizer.close();
          synthesizer = undefined;
        });

    }



    // Initialization
    document.addEventListener("DOMContentLoaded", function () {

      phrase = "Hello friend"//document.getElementById('phraseDiv').value;
      if (!!window.SpeechSDK) {
        SpeechSDK = window.SpeechSDK;

        document.getElementById('content').style.display = 'block';
      }
    });

  </script>
</body>

</html>